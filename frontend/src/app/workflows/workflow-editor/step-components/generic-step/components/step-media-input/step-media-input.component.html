<!-- MIXED MODE (Grid Layout) -->
<div *ngIf="maxItems > 1" class="input-container-mixed">
  <!-- Counter -->
  <div class="text-xs text-neutral-500 mb-2 font-medium">
    {{ items.length }}/{{ maxItems }} items selected
  </div>

  <!-- List of current items -->
  <div class="flex flex-wrap gap-2 mb-2" *ngIf="items.length">
    <div *ngFor="let item of items; let i = index" 
         class="relative h-20 w-20 flex-shrink-0 group rounded-lg overflow-hidden border border-neutral-700 bg-neutral-800">
      
      <!-- Case 1: Fixed Image/Video -->
      <ng-container *ngIf="!isStepOutputReference(item)">
        <img *ngIf="$any(item).previewUrl" [src]="$any(item).previewUrl" class="h-full w-full object-cover" />
        <div *ngIf="!$any(item).previewUrl" class="h-full w-full flex items-center justify-center">
          <mat-icon class="text-neutral-500">image</mat-icon>
        </div>
      </ng-container>

      <!-- Case 2: Linked Output -->
      <ng-container *ngIf="isStepOutputReference(item)">
        <div class="h-full w-full flex flex-col items-center justify-center p-1 text-center bg-blue-900/20">
          <mat-icon class="text-blue-400 !w-5 !h-5 !text-lg">link</mat-icon>
          <span class="text-[9px] text-blue-200 leading-tight mt-1 line-clamp-2">
            {{ getLinkedOutputLabel(item) }}
          </span>
        </div>
      </ng-container>

      <!-- Delete Button -->
      <button
        (click)="clearReferenceImage(i)"
        class="absolute top-0 right-0 p-0.5 bg-black/50 text-white hover:bg-red-500 rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"
      >
        <mat-icon class="!h-4 !w-4 !text-sm">close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Add Buttons (Always on new row) -->
  <div class="flex gap-2" *ngIf="items.length < maxItems">
    <!-- Add Fixed -->
    <div 
      class="h-10 w-10 flex flex-col items-center justify-center cursor-pointer rounded-lg border-2 border-dashed border-neutral-700 hover:border-neutral-500 hover:bg-neutral-800 transition-colors gap-1"
      (click)="openImageSelectorForReference()"
      matTooltip="Add {{ type === 'video' ? 'Video' : 'Image' }}">
      <mat-icon class="text-neutral-400 !w-5 !h-5 !text-xl">add_photo_alternate</mat-icon>
    </div>
  
    <!-- Add Linked -->
    <div 
      class="h-10 w-10 flex flex-col items-center justify-center cursor-pointer rounded-lg border-2 border-dashed border-neutral-700 hover:border-blue-500/50 hover:bg-blue-900/10 transition-colors gap-1"
      [matMenuTriggerFor]="outputMenu"
      matTooltip="Add Output Reference">
      <mat-icon class="text-blue-400 !w-5 !h-5 !text-xl">link</mat-icon>
    </div>
  
    <mat-menu #outputMenu="matMenu">
      <button mat-menu-item *ngFor="let out of compatibleOutputs" (click)="addLinkedOutput(out)">
        {{ out.label }}
      </button>
      <div *ngIf="!compatibleOutputs?.length" class="px-4 py-2 text-sm text-neutral-500">
        No compatible outputs
      </div>
    </mat-menu>
  </div>
  
   <mat-error *ngIf="control.invalid && (control.touched || showValidationErrors) && items.length === 0">
       At least one input is required
   </mat-error>
</div>

<!-- FIXED MODE (Compact Row Layout) -->
<div *ngIf="maxItems === 1" class="flex items-center gap-3">
  <div
    class="relative h-16 w-16 cursor-pointer rounded-xl border-2 border-dashed transition-colors flex items-center justify-center"
    [ngClass]="{
      'border-red-500 bg-red-500/10': control.invalid && (control.touched || showValidationErrors),
      'border-neutral-700 bg-neutral-800 hover:border-neutral-500 hover:bg-neutral-700': !(control.invalid && (control.touched || showValidationErrors))
    }"
    [class.opacity-50]="items.length >= maxItems"
    (click)="openImageSelectorForReference()"
    (dragover)="$event.preventDefault()"
    (drop)="onReferenceImageDrop($event)"
    >
    <mat-icon class="text-neutral-500">
      {{ type === 'image' ? 'add_photo_alternate' : 'video_library' }}
    </mat-icon>
    <span *ngIf="type === 'image'" class="absolute bottom-1 text-[10px] text-neutral-500">{{ items.length }}/{{ maxItems }}</span>
  </div>
  
  <!-- Show small previews of reference images -->
  <div class="flex gap-1 overflow-x-auto max-w-xs">
    <div *ngFor="let ref of items; let i = index" class="relative h-12 w-12 flex-shrink-0">
      <img *ngIf="type === 'image'" [src]="$any(ref).previewUrl" class="h-full w-full rounded-lg object-cover" />
      <div *ngIf="type === 'video'" class="h-full w-full rounded-lg bg-neutral-800 flex items-center justify-center border border-neutral-700">
        <mat-icon class="text-neutral-500 !text-lg !w-5 !h-5">
          movie
        </mat-icon>
      </div>
      <button
        (click)="clearReferenceImage(i)"
        class="absolute -right-1 -top-1 rounded-full bg-neutral-900 p-0.5 text-neutral-400 hover:text-white"
      >
        <mat-icon class="!h-3 !w-3 text-xs">close</mat-icon>
      </button>
    </div>
  </div>
</div>
